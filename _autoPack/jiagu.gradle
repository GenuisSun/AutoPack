import groovy.json.JsonSlurper

apply plugin: 'de.undercouch.download'
/**
 * @Author: stc @Date: 2020/6/14
 * @email: dearstc@163.com
 *
 * â¤-- ä½¿ç”¨360åŠ å›ºç‰ˆæœ¬ 3.2.2.3 2020-03-16 --â¤
 *
 *
 * â¤â¤â¤----------------------------------------------------------------â¤â¤â¤
 * â¤â¤â¤--TODO  Task:_autoPack
 * â¤â¤â¤--  ä¸€é”®æ‰“åŒ…--ä¸‹è½½åŠ å›ºèµ„æºæ–‡ä»¶-360åŠ å›º-ç“¦åŠ›æ‰“æ¸ é“åŒ…
 * â¤â¤â¤--  æ–¹æ³•ä¸€ æ‰§è¡Œgradleçª—å£ä¸­åˆ†ç»„_autoPackä¸‹çš„_autoPackä»»åŠ¡å³å¯
 * â¤â¤â¤--  æ–¹æ³•äºŒ Terminalçª—å£æ‰§è¡Œ(powershell)-->gradle _autoPack
 * â¤â¤â¤--                            (linux)-->./gradle _autoPack
 * â¤â¤â¤--        æ³¨ï¼šå‰ææ˜¯é…ç½®äº†gradleçš„ç¯å¢ƒå˜é‡
 * â¤â¤â¤--  å¤šå¹³å°æ”¯æŒmac/windows/linux
 * â¤â¤â¤--  å£°æ˜å¤šä¸ªTaskæ˜¯ä¸ºäº†æ–¹ä¾¿åœ¨æ‰§è¡Œæµç¨‹ä¸­ï¼Œæ›´æ¸…æ™°çš„æŸ¥é˜…åˆ°æ‰§è¡Œåˆ°é‚£ä¸ªä»»åŠ¡
 * â¤â¤â¤--  åŠ å›ºæ–‡ä»¶èµ„æºé»˜è®¤æ˜¯ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨ä»å®˜ç½‘ä¸‹è½½ï¼Œæ— éœ€ç‰¹æ„æ“ä½œ
 * â¤â¤â¤--  æ³¨ï¼šâ¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤
 * â¤â¤â¤--  æ³¨ï¼šâ¤â¤â¤â¤â¤â¤â¤â¤â¤å› ä¸ºè¦ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°  æ•…é¡¹ç›®ä¸è¦æ”¾åœ¨é«˜æƒé™çš„ç›®å½•â¤â¤â¤â¤â¤â¤â¤â¤â¤
 * â¤â¤â¤--  æ³¨ï¼šâ¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤
 * â¤â¤â¤--  æœ€ç»ˆæ¸ é“åŒ…è·¯å¾„è¯·æŸ¥çœ‹æ‰“åŒ…æµç¨‹æ—¥å¿—ï¼Œå†™çš„å¾ˆæ¸…æ¥šäº†ã€‚
 * â¤â¤â¤--
 * â¤â¤â¤--TODO  Task:assembleBetaTo*** / assembleReleaseTo***
 * â¤â¤â¤--  æ‰“åŒ…å®Œæˆä¸Šä¼ è’²å…¬è‹±/Firçš„Task  ä¾èµ–äºassembleBetaæ‰“åŒ…
 * â¤â¤â¤--  assembleBetaæ‰“åŒ…å®Œæˆè‡ªåŠ¨ä¸Šä¼ åˆ°è’²å…¬è‹± è¾“å‡ºç›¸å…³ä¿¡æ¯  æ‰“å¼€çŸ­é“¾æ¥
 * â¤â¤â¤-----------------------------------------------------------------â¤â¤â¤
 * */

/**
 * 360åŠ å›ºæ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹åå­—
 */
def folder_name = "_autoPack"

/**
 * é¡¹ç›®æ ¹è·¯å¾„çš„å†³å®šè·¯å¾„
 */
def projectPath = getRootDir().getAbsolutePath()

getRootProject().ext.jiaguConfig = [

        //360 è´¦å· (å¿…é¡»)
        "_360_user_name"         : rootProject.ext._360["account"],
        "_360_user_pw"           : rootProject.ext._360["password"],

        //ç­¾åæ–‡ä»¶é…ç½®, ä½¿ç”¨ç©ºå­—ç¬¦, ä¼šè‡ªåŠ¨èµ‹å€¼. (å¯é€‰)
        "keystorePath"           : '',
        "keystorePwd"            : '',
        "keystoreAlias"          : '',
        "keystoreAliasPwd"       : '',

        //éœ€è¦åŠ å›ºçš„APKè·¯å¾„, å¦‚æœä¸å­˜åœ¨ä»»åŠ¡ä¸­æ–­æ‰§è¡Œ, ä¸ºç©º:è‡ªåŠ¨æ ¹æ®Gradleé…ç½®è·å–è·¯å¾„ (å¯é€‰)
        "targetApkPath"          : "",

        //è‡ªåŠ¨æŸ¥æ‰¾`targetApkPath`æ—¶, å–åå­—ä¸­åŒ…å«`likeApkName`å­—ç¬¦ä¸²çš„è·¯å¾„, å¦‚æœæœ‰å¤šä¸ª, å–ç¬¬ä¸€ä¸ª
        "likeApkName"            : "",

        //æ–‡ä»¶æ‰€åœ¨çš„æ ¹ç›®å½•
        "root_path"              : projectPath + "/" + folder_name,
        //é¦–æ¬¡ä¸‹è½½360åŠ å›ºçš„ä¸´æ—¶å­˜æ”¾ç›®å½•
        "download_jiagu_path"    : projectPath + "/" + folder_name + "/tempdownload",
        //ä¸‹è½½360åŠ å›ºåŒ…çš„å…¨è·¯å¾„
        "download_jiagu_zip_path": projectPath + "/" + folder_name + "/tempdownload/360jiagubao.zip",

        //360åŠ å›ºæ–‡ä»¶æ‰€åœ¨çš„æ ¹ç›®å½•
        "jiagu_root_path"        : projectPath + "/" + folder_name + "/jiagu",
        "walle_root_path"        : projectPath + "/" + folder_name + "/walle",

        //æ¸ é“æ–‡ä»¶ä¿¡æ¯è·¯å¾„
        "channelList"            : projectPath + "/" + folder_name + "/walle/channel",

        //æ¸ é“åˆ†åŒ…åçš„APKæ–‡ä»¶å,ä¸ºç©º:è‡ªåŠ¨ä»Gradleè„šæœ¬ä¸­è·å– (å¯é€‰)
        "tmpApkName"             : "",

        //æœ€ç»ˆç”ŸæˆzipåŒ…çš„æ–‡ä»¶å (å¯é€‰)
        "zipFileName"            : "",

        //360åŠ å›ºjaræ–‡ä»¶è·¯å¾„
        "jiaguJarPath"           : projectPath + "/" + folder_name + "/jiagu/jiagu.jar",
        //walleåˆ†åŒ…jaræ–‡ä»¶è·¯å¾„
        "walleJarPath"           : projectPath + "/" + folder_name + "/walle/walle-cli-all.jar",
        //ä¸´æ—¶æ–‡ä»¶è¾“å‡ºç›®å½•
        "tmpOutput"              : projectPath + "/" + folder_name + "/output/tmp",
        //zipæ–‡ä»¶è¾“å‡ºç›®å½•
        "zipOutput"              : projectPath + "/" + folder_name + "/output/zip",
        //åŠ å›ºåæ–‡ä»¶è¾“å‡ºç›®å½•
        "jiaguOutput"            : projectPath + "/" + folder_name + "/output/jiagu",
        //walleåˆ†åŒ…è¾“å‡ºç›®å½•
        "walleOutput"            : projectPath + "/" + folder_name + "/output/walle",

        //todo 360åŠ å›ºä¿ é¦–æ¬¡é…ç½®è‡ªåŠ¨ä¸‹è½½  ä¸‹æ–¹é“¾æ¥ä¸ºå®˜æ–¹é“¾æ¥ï¼Œå¦‚å®˜æ–¹æœ‰æ”¹åŠ¨  å¯æ”¹
        //åŠ å›ºmacä¸‹è½½åœ°å€
        "jiagubao_mac"           : "https://down.360safe.com/360Jiagu/360jiagubao_mac.zip",
        //åŠ å›ºwidnowsä¸‹è½½åœ°å€
        "jiagubao_windows"       : "https://down.360safe.com/360Jiagu/360jiagubao_windows_64.zip",
        //åŠ å›ºlinuxä¸‹è½½åœ°å€
        "jiagubao_linux"         : "https://down.360safe.com/360Jiagu/360jiagubao_linux_64.zip"

]
//â¤â¤â¤â¤â¤â¤startâ¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤
/**
 * æŠŠå£°æ˜çš„ å¸¸ç”¨æ‰“åŒ…ä»»åŠ¡ éƒ½è½¬ç§»åˆ°_autoPackåˆ†ç»„ä¸­
 * å¹¶ä¸ºè¯¥ä»»åŠ¡è®¾ç½®ä¾èµ–cleanå…³ç³»  å³æ¯æ¬¡è‡ªåŠ¨åˆ é™¤buildæ–‡ä»¶å¤¹
 */
project.afterEvaluate {
    project.android.applicationVariants.all { variant ->
        def pack = 'assemble' + variant.name.capitalize()
        if (null != project.tasks.findByPath(pack) && folder_name != project.tasks.getByName(pack).getGroup()) {
            project.tasks.getByName(pack).setGroup(folder_name)
            project.tasks.getByName(pack).dependsOn('clean')
        }
    }
}

// è¾“å‡ºæ‰§è¡Œä»»åŠ¡å ç”¨äºè°ƒè¯•
//gradle.taskGraph.beforeTask { Task task ->
//    println "executing $task ..."
//}
//â¤â¤â¤â¤â¤â¤endâ¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤


//â¤â¤â¤â¤â¤â¤startæ‰“åŒ…æµç¨‹â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤
/**
 * æ ¹æ®ç³»ç»Ÿä¸‹è½½ç›¸åº”çš„360åŠ å›ºèµ„æºåŒ…
 */
task downloadZipFile(dependsOn: 'assembleRelease') {
    //å…ˆåˆ¤æ–­æœ¬åœ°æœ‰æ²¡æœ‰åŠ å›ºæ–‡ä»¶å¤¹ï¼Œä¸€èˆ¬é¡¹ç›®ç¬¬ä¸€æ¬¡cloneä¸‹æ¥çš„æ—¶å€™éƒ½æ˜¯ä¸å­˜åœ¨çš„
    //é¦–æ¬¡éœ€è‡ªåŠ¨ä¸‹è½½
    File folder = file(jiaguConfig.jiagu_root_path)
    File file = file(jiaguConfig.jiaguJarPath)
    //enabledå±æ€§---æ˜¯å¦è·³è¿‡å½“å‰ä»»åŠ¡
    enabled = !(folder.exists() && file.exists())
    doFirst {
        color_print "æ‰§è¡ŒassembleReleaseæ‰“åŒ…ä»»åŠ¡å®Œæ¯•"
        if (!enabled) {
            color_print "360åŠ å›ºæ–‡ä»¶å¤¹ å’Œ åŠ å›ºjaræ–‡ä»¶å­˜åœ¨"
        } else {
            color_print "360åŠ å›ºæ–‡ä»¶å¤¹æˆ–è€…åŠ å›ºjaræ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¸ºè¯¥ç³»ç»Ÿæœ¬åœ°ä¸‹è½½ç›¸å…³èµ„æºåŒ…"
        }
    }
    doLast {
        //TODO æ–¹æ³•ä¸€ï¼šä½¿ç”¨de.undercouch.download ä¸‹è½½èµ„æº
//        download {
//            src getJiaGuZipUrlByOs()
//            dest new File(jiaguConfig.download_jiagu_zip_path)
//            overwrite false
//        }
        //TODO æ–¹æ³•äºŒï¼šä½¿ç”¨ç³»ç»Ÿcurlå‘½ä»¤ ä¸‹è½½èµ„æº ç›®å‰æµ‹è¯•window10 macæ­£å¸¸æ”¯æŒ
        File zipFile = new File(jiaguConfig.download_jiagu_zip_path)
        if (!zipFile.exists()) {
            if (!zipFile.parentFile.exists()) {
                zipFile.parentFile.mkdirs()
            }
            def downloadUrl = getJiaGuZipUrlByOs()
            def cmd = "curl -o ${jiaguConfig.download_jiagu_zip_path} ${downloadUrl}"
            cmd.execute().waitForProcessOutput(System.out, System.err)
        }
        color_print "360åŠ å›ºèµ„æºåŒ…ä¸‹è½½å®Œæˆ è·¯å¾„åœ¨" + jiaguConfig.download_jiagu_zip_path
        color_print "æ‰§è¡Œè§£å‹ä»»åŠ¡ â¤unzipFileâ¤ è¯·ç¨åã€‚ã€‚ã€‚"
    }
}

/**
 * è§£å‹ä¸‹è½½çš„åŠ å›ºåŒ…
 */
task unzipFile(dependsOn: downloadZipFile, type: Copy) {
    //onlyIfå±æ€§è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œåˆ¤æ–­å½“å‰ä»»åŠ¡æ˜¯å¦æ‰§è¡Œ
    onlyIf { downloadZipFile.enabled }
    from zipTree(jiaguConfig.download_jiagu_zip_path)
    into jiaguConfig.download_jiagu_path
    doLast {
        File folder = file(jiaguConfig.download_jiagu_path)
        for (File f : folder.listFiles()) {
            color_print "è§£å‹æˆåŠŸ:" + f
        }
        color_print "å…¨éƒ¨è§£å‹å®Œæˆ  å‡†å¤‡å°†è§£å‹å‡ºæ¥çš„jiaguæ–‡ä»¶å¤¹å¤åˆ¶åˆ°" + jiaguConfig.root_path + "æ–‡ä»¶å¤¹ä¸‹"
        color_print "æ‰§è¡Œå¤åˆ¶ä»»åŠ¡ â¤copyDownloadJiaGuâ¤ è¯·ç¨åã€‚ã€‚ã€‚"
    }
}

/**
 * å¤åˆ¶è§£å‹ä¸‹è½½çš„åŠ å›ºåŒ…ä¸­çš„jiaguæ–‡ä»¶å¤¹åˆ°é…ç½®æ–‡ä»¶å¤¹
 */
task copyDownloadJiaGu(dependsOn: unzipFile) {
    onlyIf { downloadZipFile.enabled }
    //ä¸‹è½½çš„360åŠ å›ºzipè§£å‹å‡ºçš„jiaguæ–‡ä»¶å®¶è·¯å¾„
    def downnload_jiagu = jiaguConfig.download_jiagu_path + "/jiagu"
    doFirst {
        File folder = file(downnload_jiagu)
        if (!folder.exists()) {
            File file1 = new File(jiaguConfig.download_jiagu_path)
            if (file1.exists()) {
                color_print "åˆ é™¤èµ„æºä¸‹è½½ä¸´æ—¶ç›®å½•ï¼š" + file1 + "   " + file1.deleteDir()
            }
            File file2 = new File(jiaguConfig.jiagu_root_path)
            if (file2.exists()) {
                color_print "åˆ é™¤åˆ›å»ºçš„jiaguæ–‡ä»¶å¤¹ï¼š" + file2 + "   " + file2.deleteDir()
            }
            throw new RuntimeException("æ²¡æœ‰åœ¨è§£å‹çš„æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°jiaguæ–‡ä»¶å¤¹ï¼Œè¯·é‡è¯• æˆ–è€… æ‰‹åŠ¨å®˜ç½‘ä¸‹è½½ç›¸å…³360åŠ å›ºæ–‡ä»¶ï¼Œå°†èµ„æºåŒ…ä¸­çš„jiaguæ–‡ä»¶å¤¹è§£å‹åˆ°ï¼š" + jiaguConfig.root_path + "æ–‡ä»¶å¤¹ä¸‹")
        }
        copy {
            from downnload_jiagu
            into jiaguConfig.jiagu_root_path
        }
    }
    doLast {
        color_print "å¤åˆ¶å®Œæˆã€‚ã€‚ã€‚copy " + downnload_jiagu + " to " + jiaguConfig.jiagu_root_path
        File filedir = new File(jiaguConfig.download_jiagu_path)
        color_print "åˆ é™¤ä¸‹è½½çš„èµ„æºä¸´æ—¶å­˜æ”¾æ–‡ä»¶å¤¹ï¼š" + filedir + "   " + filedir.deleteDir()
        color_print "ä¸‹è½½åŠ å›ºèµ„æºæµç¨‹ç»“æŸ,å¼€å§‹è¿›è¡Œ360åŠ å›ºã€‚ã€‚ã€‚"

    }
}


/**
 * è¿›è¡Œç™»å½•
 */
task login(type: JavaExec, dependsOn: copyDownloadJiaGu) {
    workingDir(jiaguConfig.jiagu_root_path)
    classpath(files(jiaguConfig.jiaguJarPath))
    main('com.qihoo.jiagu.CmdMain')
    args('-login', jiaguConfig._360_user_name, jiaguConfig._360_user_pw)
}

/**
 * ç™»å½•å‰ï¼ˆ2ï¼‰ è¿›è¡Œç›¸å…³æ–‡ä»¶å¤¹çš„åˆ›å»ºå’Œæ¸…ç©º
 */
login.doFirst {
    File targetFile = new File(jiaguConfig.targetApkPath)
    if (!targetFile.exists()) {
        throw new RuntimeException("åŠ å›ºapkæ–‡ä»¶ä¸å­˜åœ¨:" + targetFile.getAbsolutePath())
    } else {
        color_print("å¼€å§‹åŠ å›º:" + targetFile.getAbsolutePath())
        color_print("è¾“å‡ºæ¸ é“åŒ…zipè·¯å¾„:" + jiaguConfig.zipOutput)
    }
    //åˆ›å»ºåŸºç¡€æ–‡ä»¶å¤¹
    createFolder(jiaguConfig.walleOutput, true)
    createFolder(jiaguConfig.zipOutput)
    createFolder(jiaguConfig.jiaguOutput, true)
    createFolder(jiaguConfig.tmpOutput, true)
    checkZipFolderNum(jiaguConfig.zipOutput)
}

/**
 * ç™»å½•å‰ï¼ˆ1ï¼‰åˆå§‹åŒ–ç›¸å…³è·¯å¾„ä¿¡æ¯  ç­¾åä¿¡æ¯
 */
login.doFirst {
    project.android.applicationVariants.all { variant ->
        //å¯¹åº”app/build.gradleæ–‡ä»¶å£°æ˜ buildTypes ä¸‹å£°æ˜çš„æ‰“åŒ…ç±»å‹
        if (
        (jiaguConfig.likeApkName == "" && variant.name.toLowerCase() == "release")
                || (jiaguConfig.likeApkName != "" && variant.name.toLowerCase().contains(jiaguConfig.likeApkName))
        ) {
            color_print("åˆå§‹åŒ–ç›¸å…³è·¯å¾„ä¿¡æ¯  ç­¾åä¿¡æ¯ï¼Œå½“å‰æ‰“åŒ…æ–¹å¼ï¼š" + variant.name.toLowerCase())
            if (jiaguConfig.keystorePath == '') {
                //è‡ªåŠ¨é…ç½®ç­¾åä¿¡æ¯
                jiaguConfig.keystorePath = variant.signingConfig.storeFile
                jiaguConfig.keystorePwd = variant.signingConfig.storePassword
                jiaguConfig.keystoreAlias = variant.signingConfig.keyAlias
                jiaguConfig.keystoreAliasPwd = variant.signingConfig.keyPassword


                List<String> list = new ArrayList<>()
                list.add('-importsign')
                list.add(jiaguConfig.keystorePath)
                list.add(jiaguConfig.keystorePwd)
                list.add(jiaguConfig.keystoreAlias)
                list.add(jiaguConfig.keystoreAliasPwd)

                color_print "ä½¿ç”¨ç­¾å:" + list

                setKeystore.setArgs(list)
            }

            variant.outputs.each { output ->
                //è‡ªåŠ¨é…ç½®ç›®æ ‡æ–‡ä»¶è·¯å¾„, å’Œä¸´æ—¶æ–‡ä»¶å
                if (jiaguConfig.targetApkPath == "") {
                    jiaguConfig.targetApkPath = output.outputFile.getAbsolutePath()
                    color_print "è¯»å–åˆ°ç›®æ ‡apkè·¯å¾„:" + jiaguConfig.targetApkPath
                }

                if (jiaguConfig.tmpApkName == '') {
                    jiaguConfig.tmpApkName = output.outputFile.getName()
                    color_print "ä¸´æ—¶æ–‡ä»¶å:" + jiaguConfig.tmpApkName
                }
                copyTmpApk.rename('(.+)', jiaguConfig.tmpApkName)

                if (jiaguConfig.zipFileName == '') {
                    jiaguConfig.zipFileName = jiaguConfig.tmpApkName
                            .substring(0, jiaguConfig.tmpApkName.lastIndexOf('.')) + "_channel.zip"
                    color_print "zipæ–‡ä»¶å:" + jiaguConfig.zipFileName
                }

                zipChannel.archiveName = jiaguConfig.zipFileName

                //é‡ç½®åŠ å›ºtaskå‚æ•°
                List<String> list = new ArrayList<>()
                list.add('-jiagu')
                list.add(jiaguConfig.targetApkPath)
                list.add(jiaguConfig.jiaguOutput)
                list.add('-autosign')
                jiagu360.setArgs(list)

                //é‡ç½®walle taskå‚æ•°
                list = new ArrayList<>()
                list.add('batch')
                list.add('-f')
                list.add(jiaguConfig.channelList)
                list.add(jiaguConfig.tmpOutput + File.separator + jiaguConfig.tmpApkName)
                list.add(jiaguConfig.walleOutput)
                walleApk.setArgs(list)
            }
        }
    }
}

/**
 * è®¾ç½®ç­¾åé…ç½®
 */
task setKeystore(type: JavaExec, dependsOn: login) {
    workingDir(jiaguConfig.jiagu_root_path)
    classpath(files(jiaguConfig.jiaguJarPath))
    main('com.qihoo.jiagu.CmdMain')
}

/**
 * æ˜¾ç¤ºç­¾åä¿¡æ¯
 */
task showKeystore(type: JavaExec) {
    workingDir(jiaguConfig.jiagu_root_path)
    classpath(files(jiaguConfig.jiaguJarPath))
    main('com.qihoo.jiagu.CmdMain')
    args('-showsign')
}

/**
 * è¿›è¡ŒåŠ å›º
 */
task jiagu360(type: JavaExec, dependsOn: setKeystore) {
    workingDir(jiaguConfig.jiagu_root_path)
    classpath(files(jiaguConfig.jiaguJarPath))
    main('com.qihoo.jiagu.CmdMain')
}


/**
 * åŠ å›ºåçš„åŒ…ä¿ç•™,æ‹·è´ä¸€ä»½åœ¨tmpé‡Œé¢
 */
task copyTmpApk(type: Copy, dependsOn: jiagu360) {
    from(jiaguConfig.jiaguOutput)
    include('*.apk')
    into(jiaguConfig.tmpOutput)
}

/**
 * ç“¦åŠ›æ‰“æ¸ é“åŒ…
 */
task walleApk(type: JavaExec, dependsOn: copyTmpApk) {
    workingDir(jiaguConfig.walle_root_path)
    classpath(files(jiaguConfig.walleJarPath))
    main('com.meituan.android.walle.Main')
}

/**
 * ç“¦åŠ›å°†æ¸ é“åŒ…æ‰“å‹ç¼©åŒ…
 */
task zipChannel(type: Zip, dependsOn: walleApk) {
    //workingDir(baseBuildPath)
    from(jiaguConfig.walleOutput)
    //åŠ¨æ€è®¾ç½®
    archiveName(jiaguConfig.zipFileName)
    destinationDir file(jiaguConfig.zipOutput)
}

/**
 * ä¸»ä»»åŠ¡===ã€‹ ä¸€é”®æ‰“åŒ…--ä¸‹è½½åŠ å›ºèµ„æºæ–‡ä»¶-360åŠ å›º-ç“¦åŠ›æ‰“æ¸ é“åŒ…
 */
task _autoPack(dependsOn: zipChannel, description: 'ä¸€é”®æ‰“åŒ…--ä¸‹è½½åŠ å›ºèµ„æºæ–‡ä»¶-360åŠ å›º-ç“¦åŠ›æ‰“æ¸ é“åŒ…') {
    group folder_name
    doLast {
        color_print "åŠ å›ºæ‰“åŒ…æµç¨‹ç»“æŸ:"
        color_printSuccess("æ¸ é“åŒ…è·¯å¾„:" + jiaguConfig.walleOutput)
        color_printSuccess("zipåŒ…è·¯å¾„:" + jiaguConfig.zipOutput)
    }
}

/**
 * åˆ›å»ºè·¯å¾„
 */
def createFolder(String path, boolean clear = false) {
    File folder = file(path)
    if (folder.exists()) {
        if (clear) {
            clearFolder(path)
        }
    } else {
        folder.mkdirs()
    }
}

/**
 * æ¸…ç†æ–‡ä»¶å¤¹
 */
def clearFolder(String path) {
    File folder = file(path)
    for (File f : folder.listFiles()) {
        if (f.isDirectory()) {
            clearFolder(f.getAbsolutePath())
        } else if (f.isFile()) {
            color_print "åˆ é™¤æ–‡ä»¶:" + f + " " + f.delete()
        }
    }
}

/**
 * æ£€æµ‹æ¸ é“zipæ–‡ä»¶å¤¹ä¸‹å‹ç¼©åŒ…æ•°é‡ï¼Œé¿å…è¿‡å¤šæœ¬åœ°å­˜å‚¨
 * ç›®å‰è®¾ç½®æœ€å¤šå­˜å‚¨äº”æ¬¡æ¸ é“åŒ…å†å²
 * @param path
 */
def checkZipFolderNum(def path) {
    //æ–‡ä»¶è·¯å¾„
    List<File> list = getFileSort(path)
    for (int i = 0; i < list.size(); i++) {
        if (i >= 5) {
            color_print "åˆ é™¤å†å²æ¸ é“zipåŒ…:" + list.get(i).getName() + " " + list.get(i).delete()
        }
    }
}

/**
 * è·å–ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶(æŒ‰æ—¶é—´æ’åº)
 *
 * @param path
 * @return
 */
def getFileSort(String path) {

    List<File> list = getFiles(path, new ArrayList<File>())

    if (list != null && list.size() > 0) {

        Collections.sort(list, new Comparator<File>() {
            @Override
            int compare(File file, File newFile) {
                if (file.lastModified() < newFile.lastModified()) {
                    return 1
                } else if (file.lastModified() == newFile.lastModified()) {
                    return 0
                } else {
                    return -1
                }
            }
        })
    }

    return list
}
/**
 * è·å–ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶
 * @param realpath
 * @param files
 * @return
 */
def getFiles(String realpath, List<File> files) {
    File realFile = new File(realpath)
    if (realFile.isDirectory()) {
        File[] subfiles = realFile.listFiles()
        for (File file : subfiles) {
            if (file.isDirectory()) {
                getFiles(file.getAbsolutePath(), files)
            } else {
                files.add(file)
            }
        }
    }
    return files
}

/**
 * è·å–å½“å‰æ“ä½œç³»ç»Ÿçš„360åŠ å›ºèµ„æºä¸‹è½½é“¾æ¥
 */
def getJiaGuZipUrlByOs() {
    def url
    String osName = org.gradle.internal.os.OperatingSystem.current().getName();
    String osVersion = org.gradle.internal.os.OperatingSystem.current().getVersion();
    color_print "å½“å‰ä½¿ç”¨ç³»ç»Ÿ $osName $osVersion was detected."

    if (org.gradle.internal.os.OperatingSystem.current().isLinux()) {
        url = jiaguConfig.jiagubao_linux
    } else if (org.gradle.internal.os.OperatingSystem.current().isWindows()) {
        url = jiaguConfig.jiagubao_windows
    } else if (org.gradle.internal.os.OperatingSystem.current().isMacOsX()) {
        url = jiaguConfig.jiagubao_mac
    } else {
        throw new RuntimeException("ä¸æ”¯æŒå½“å‰æ“ä½œç³»ç»Ÿï¼š" + osName)
    }
    color_print "å¯¹åº”è¦ä¸‹è½½360åŠ å›ºåŒ…çš„é“¾æ¥åœ°å€ä¸ºï¼š" + url
    return url
}

//â¤â¤â¤â¤â¤â¤endæ‰“åŒ…æµç¨‹â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤


//â¤â¤â¤â¤â¤â¤startè’²å…¬è‹±/firâ¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤

/**
 * æ‰“æµ‹è¯•åŒ…å¹¶ä¸Šä¼ åˆ°è’²å…¬è‹±
 */
task assembleBetaToPGY(dependsOn: 'assembleBeta', description: 'æ‰“æµ‹è¯•åŒ…å¹¶ä¸Šä¼ åˆ°è’²å…¬è‹±') {
    group folder_name
    doLast {
        _uploadApp('beta', false)
    }
}

/**
 * æ‰“æ­£å¼åŒ…å¹¶ä¸Šä¼ åˆ°è’²å…¬è‹±
 */
task assembleReleaseToPGY(dependsOn: 'assembleRelease', description: 'æ‰“æ­£å¼åŒ…å¹¶ä¸Šä¼ åˆ°è’²å…¬è‹±') {
    group folder_name
    doLast {
        _uploadApp('release', false)
    }
}
/**
 * æ‰“æµ‹è¯•åŒ…å¹¶ä¸Šä¼ åˆ°fir
 */
task assembleBetaToFir(dependsOn: 'assembleBeta', description: 'æ‰“æµ‹è¯•åŒ…å¹¶ä¸Šä¼ åˆ°Fir') {
    group folder_name
    doLast {
        _uploadApp('beta', true)
    }
}

/**
 * æ‰“æ­£å¼åŒ…å¹¶ä¸Šä¼ åˆ°fir
 */
task assembleReleaseToFir(dependsOn: 'assembleRelease', description: 'æ‰“æ­£å¼åŒ…å¹¶ä¸Šä¼ åˆ°Fir') {
    group folder_name
    doLast {
        _uploadApp('release', true)
    }
}

/**
 * ä¸Šä¼ apkè‡³è’²å…¬è‹±å‰è¿›è¡Œè·¯å¾„æ–‡ä»¶æ£€æŸ¥
 */
def _uploadApp(String name, boolean fir) {
    project.outgoingVariants.
            project.android.applicationVariants.all { variant ->
        //å¯¹åº”app/build.gradleæ–‡ä»¶å£°æ˜ buildTypes ä¸‹å£°æ˜çš„æ‰“åŒ…ç±»å‹
        if (variant.name.toLowerCase().endsWith(name)) {
            variant.outputs.each { output ->
                color_print "ä¸Šä¼ " + (fir ? " firå¹³å° " : " è’²å…¬è‹±å¹³å° ") + "çš„apkè·¯å¾„:" + output.outputFile.getAbsolutePath()
                File dir = new File(output.outputFile.getAbsolutePath())
                if (!dir.exists()) {
                    throw new RuntimeException("ç›®æ ‡apkè·¯å¾„ not existsï¼š" + dir.path)
                }
                if (fir) {
                    //ä¸Šä¼ fir
                    uploadFir(dir.path)
                } else {
                    //ä¸Šä¼ è’²å…¬è‹±
                    uploadPGY(dir.path)
                }
            }
        }
    }

}

/**
 * ä¸Šä¼ apkåˆ°è’²å…¬è‹±
 */
private def uploadPGY(String filePath) {
    def stdout = new ByteArrayOutputStream()
    exec {
        executable = 'curl'
        args = ['-F', "file=@${filePath}",
                '-F', "uKey=${rootProject.ext.pgy["uKey"]}",
                '-F', "_api_key=${rootProject.ext.pgy["apiKey"]}",
                rootProject.ext.pgy["uploadUrl"]]
        standardOutput = stdout
    }
    String output = stdout.toString()
//    color_print(output)
    def parsedJson = new JsonSlurper().parseText(output)
    color_printSuccess "ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ä¸Šä¼ æˆåŠŸğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™"
    color_printSuccess "Appçš„å®‰è£…åŒ…åç§°ï¼š" + parsedJson.data.buildFileName
    color_printSuccess "Appç‰ˆæœ¬åç§°ï¼š" + parsedJson.data.buildVersion
    color_printSuccess "Appç‰ˆæœ¬å·ï¼š" + parsedJson.data.buildVersionNo
    color_printSuccess "AppBuildVersionï¼š" + parsedJson.data.buildBuildVersion
    color_printSuccess "AppåŒ…ä½“ç§¯ï¼š" + parsedJson.data.buildFileSize
    color_printSuccess "Appä¸‹è½½é¡µåœ°å€ï¼šhttps://www.pgyer.com/" + parsedJson.data.buildShortcutUrl
//    color_printSuccess "AppäºŒç»´ç åœ°å€ï¼š" + parsedJson.data.buildQRCodeURL
    color_printSuccess "Appä¸Šä¼ æ—¶é—´ï¼š" + parsedJson.data.buildCreated
    color_printSuccess "ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ä¿¡æ¯æ‰“å°å®Œæ¯•ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™"
    openBrowser("https://www.pgyer.com/" + parsedJson.data.buildShortcutUrl)
}


/**
 * ä¸Šä¼ apkåˆ°fir
 * @param filePath
 * @return
 */
def uploadFir(String filePath) {
    //fir api_token
    def FIR_API_TOKEN = rootProject.ext.fir["apiToken"]
    //packageName firä¸Šåº”ç”¨çš„åŒ…å
    def packageName = project.android.defaultConfig.applicationId
    //è·å–firä¸Šä¼ å‡­è¯çš„å„ä¸ªå­—æ®µ
    def appInfo = ("curl -X POST -d type=android&bundle_id=$packageName&api_token=$FIR_API_TOKEN http://api.fir.im/apps").execute().text

//    color_print(appInfo.toString())
    //jsonè§£æå¯¹è±¡æ‹¿åˆ°çš„æ˜¯Map, é›†åˆå¯¹åº”çš„æ˜¯array, æŒ‰ç…§è¿™ä¸ªè§„åˆ™å–å‡ºæˆ‘ä»¬éœ€è¦çš„æ•°æ®
    def appInfoBean = new JsonSlurper().parseText(appInfo)
    //çŸ­é“¾æ¥
    def buildShortcutUrl = "http://" + appInfoBean["download_domain"] + "/" + appInfoBean["short"]
    //åº”ç”¨id ç”¨æ¥ä¿®æ”¹åº”ç”¨ä¿¡æ¯
    def id = appInfoBean["id"]

    File file = file(rootProject.ext.fir["appIcon"])
    if (file.exists()) {
        //ä¸Šä¼ åº”ç”¨icon
        def uploadIcon = new ByteArrayOutputStream()
        exec {
            executable = 'curl'
            args = ['-F', "file=@${rootProject.ext.fir["appIcon"]}",
                    '-F', "token=${appInfoBean["cert"]["icon"]["token"]}",
                    '-F', "key=${appInfoBean["cert"]["icon"]["key"]}",
                    appInfoBean["cert"]["icon"]["upload_url"]]
            standardOutput = uploadIcon
        }
        color_print("åº”ç”¨iconä¸Šä¼ ç»“æœ(æ— å½±å“ï¼Œéå¿…è¦)ï¼š" + uploadIcon.toString())
    } else {
        color_printError("åº”ç”¨iconæ–‡ä»¶ä¸å­˜åœ¨(æ— å½±å“ï¼Œéå¿…è¦)ï¼šè‹¥éœ€è¦ï¼Œè¯·æ£€æŸ¥å…¨å±€å˜é‡firçš„appIconè®¾ç½®çš„è·¯å¾„å›¾ç‰‡æ˜¯å¦å­˜åœ¨")
    }

    //ä¸Šä¼ apkæ–‡ä»¶
    def upload = ("curl -X POST --form file=@$filePath" +
            " -F token=${appInfoBean["cert"]["binary"]["token"]}" +
            " -F key=${appInfoBean["cert"]["binary"]["key"]}" +
            " -F x:version=$project.android.defaultConfig.versionName" +
            " -F x:build=$project.android.defaultConfig.versionCode" +
            " -F x:changelog=123456" +
            " ${appInfoBean["cert"]["binary"]["upload_url"]}").execute().text

//    color_print upload.toString()
    try {
        def uploadResult = new JsonSlurper().parseText(upload)
        if (uploadResult.is_completed) {
            //ä¿®æ”¹appåº”ç”¨åç§° å¦‚æœåœ¨ç›´æ¥ä¸Šä¼ é‡Œé¢è®¾ç½®appnameä¼šä¸­æ–‡ä¹±ç ï¼Œæ•…éœ€è¦é‡æ–°èµ°ä¸€ä¸‹ä¿®æ”¹ä¿¡æ¯  å®˜æ–¹æœªè§£é‡ŠåŸå› 
            def appName = URLEncoder.encode(rootProject.ext.fir["appName"])
            def updateInfo = ("curl -X PUT -d name=$appName -d api_token=$FIR_API_TOKEN http://api.bq04.com/apps/$id").execute().text
//            color_print(updateInfo.toString())
            color_printSuccess "ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ä¸Šä¼ æˆåŠŸğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™"
            color_printSuccess ""
            color_printSuccess ""
            color_printSuccess "     firä¸‹è½½çŸ­é“¾æ¥ä¸ºï¼š" + buildShortcutUrl
            color_printSuccess ""
            color_printSuccess ""
            color_printSuccess "ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ä¿¡æ¯æ‰“å°å®Œæ¯•ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™"
            openBrowser(buildShortcutUrl)
        } else {
            color_printError "apkä¸Šä¼ å¤±è´¥"
        }
    } catch (Exception e) {
        color_printError "apkä¸Šä¼ å¤±è´¥"
    }
}

def openBrowser(String url) {
    //æ‰“å¼€çŸ­é“¾æ¥
    exec {
        if (org.gradle.internal.os.OperatingSystem.current().isLinux()) {
            commandLine "x-www-browser", url
        } else if (org.gradle.internal.os.OperatingSystem.current().isWindows()) {
            commandLine "powershell", "start", url
        } else if (org.gradle.internal.os.OperatingSystem.current().isMacOsX()) {
            commandLine "open", url
        }
    }
}

//â¤â¤â¤â¤â¤â¤-----endè’²å…¬è‹±/fir-----â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤â¤

/**
 * å½©è‰²æ—¥å¿—æ‰“å°
 * printf("\033[å­—èƒŒæ™¯é¢œè‰²;å­—ä½“é¢œè‰²m å­—ç¬¦ä¸² \033[0m" );
 * @param value
 * @return
 */
def color_print(String value) {
    printf "\033[1;33mğŸš¶ğŸƒğŸš¶ğŸƒğŸš¶ğŸƒğŸš¶ğŸƒ\t%s\033[0m\n", value
}

def color_printSuccess(String value) {
    printf "\033[1;32mğŸ‘™ğŸ‘™ğŸ‘™ğŸ‘™\t%s\033[0m\n", value
}

def color_printError(String value) {
    printf "\033[1;31mğŸ’€ğŸ’€ğŸ’€ğŸ’€\t%s\033[0m\n", value
}
